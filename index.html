<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proyecto de C√°tedra ‚Äì Conducci√≥n Nivel Secci√≥n (Caballer√≠a)</title>
  <!-- D3 v7 desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{
      --bg:#f7fafd; --panel:#ffffff; --ink:#222b45; --muted:#7a8ca5;
      --brand:#ffd34d; --accent:#4da3ff; --ok:#54d17a; --danger:#ff6b6b;
      --link:#2f405a; --node:#e3eaf7; --nodeHover:#d0e2ff; --edge:#b3c2db;
      --shadow:0 4px 24px rgba(77,163,255,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Segoe UI Emoji";
      display:flex; flex-direction:column; min-height:100%;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:14px 18px; border-bottom:1px solid #202938; background:linear-gradient(180deg, rgba(255,211,77,0.07), rgba(0,0,0,0));
    }
    header h1{font-size:18px; margin:0; color:var(--brand); letter-spacing:.3px}
    header .sub{color:var(--muted); font-size:13px}
    .toolbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto;
    }
    .btn{
      background:var(--panel); color:var(--ink); border:1px solid #223045; border-radius:10px; padding:8px 10px; font-size:13px; cursor:pointer;
      transition:all .2s ease; box-shadow:0 0 0 rgba(0,0,0,0);
    }
    .btn:hover{background:#1b2330}
    .btn.primary{border-color:#3d4f6d; background:#192230}
    .btn.danger{border-color:#52313a; color:#ffd0d0}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    
    /* Modo Presentaci√≥n */
    .presentation-btn { background: #ff6b6b; color: white; }
    .presentation-btn:hover { background: #ff5252; }
    
    .auto-tour-btn { background: #54d17a; color: white; }
    .auto-tour-btn:hover { background: #4caf50; }
    
    .presentation-mode {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .presentation-content {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 60px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
    }
    
    .presentation-title {
      font-size: 3em;
      color: #2c5aa0;
      margin-bottom: 30px;
      font-weight: bold;
    }
    
    .presentation-content h2 {
      color: #333;
      font-size: 2em;
      margin: 30px 0 15px 0;
    }
    
    .presentation-content p {
      font-size: 1.3em;
      line-height: 1.6;
      color: #555;
      margin-bottom: 20px;
    }
    
    .presentation-nav {
      position: absolute;
      bottom: 20px;
      right: 20px;
    }
    
    .presentation-nav button {
      margin: 0 10px;
      padding: 15px 25px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #4da3ff;
      color: white;
    }
    
    .close-presentation {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
    }

    .layout{display:grid; grid-template-columns: 320px 1fr; gap:0; min-height:0; flex:1}
    aside{
  background:var(--panel); border-right:1px solid #e3eaf7; padding:32px 28px; overflow:auto;
  box-shadow:var(--shadow);
  min-width:320px;
    }
    aside h2{font-size:13px; color:var(--muted); margin:8px 0}
    .search{display:flex; gap:8px; margin-bottom:8px}
    .search input{
      width:100%; background:#0f131a; color:var(--ink); border:1px solid #24334b; outline:none; border-radius:10px; padding:10px 12px; font-size:13px;
    }
    .breadcrumbs{font-size:12px; color:var(--muted); line-height:1.4; padding:8px 0}
    .breadcrumbs span{color:var(--ink)}
    .legend{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 10px}
    .tag{font-size:11px; color:#c7d7ea; background:#0f131a; border:1px solid #223045; padding:5px 8px; border-radius:999px}
    .mini{border:1px dashed #2a3952; border-radius:12px; padding:10px; margin-top:6px; font-size:12px; color:#c7d7ea}
    .mini p{margin:6px 0}

    main{position:relative; overflow:hidden}
    #chart{position:absolute; inset:0}
    .hint{position:absolute; right:12px; bottom:12px; font-size:12px; color:var(--muted); background:#0f131a; border:1px solid #24334b; padding:8px 10px; border-radius:8px}

    /* Node styles */
    .node rect{
  stroke:var(--edge); stroke-width:2px; rx:18; ry:18; filter: drop-shadow(0 4px 16px rgba(77,163,255,0.10));
  /* El color de fondo se asigna din√°micamente por JS */
    }
    .node:hover rect{fill:var(--nodeHover); stroke:var(--accent)}
    .node text{font-size:16px; fill:var(--ink); font-weight:600}
    .node .small{fill:var(--muted); font-size:13px; font-weight:400}
    .node .pill{
      fill:var(--accent); stroke:var(--accent); stroke-width:1px; rx:12; ry:12;
    }
    .node .pillText{font-size:13px; fill:#fff; font-weight:700}

    .link{fill:none; stroke:var(--edge); stroke-width:1.2px}

    /* Collapse chevron */
    .chev{cursor:pointer}
    .chev text{font-size:14px; fill:#9fb0c3}

    /* Info panel */
    .info{background:#0f131a; border:1px solid #24334b; padding:12px; border-radius:12px; margin-top:8px}
  .info{background:#e3eaf7; border:1px solid #b3c2db; padding:24px; border-radius:20px; margin-top:18px; box-shadow:var(--shadow)}
  .info h3{margin:0 0 14px 0; font-size:18px; color:var(--accent); font-weight:700}
  .info p{margin:10px 0; font-size:15px; color:var(--ink)}
  .info ul{margin:14px 0 0 28px; padding:0}
  .info li{margin:8px 0; color:var(--muted); font-size:14px}
  </style>
</head>
<body>
  <header>
    <h1>Proyecto de C√°tedra ‚Äì Conducci√≥n Nivel Secci√≥n</h1>
    <div class="sub">Caballer√≠a ¬∑ Presentaci√≥n interactiva (tipo cuadro sin√≥ptico)</div>
    <div class="toolbar">
      <button id="btnExpand" class="btn primary" title="Expandir todo">Expandir</button>
      <button id="btnCollapse" class="btn" title="Colapsar todo">Colapsar</button>
      <button id="btnHome" class="btn" title="Vista general">Vista general</button>
              <button id="btnFocusUD3" class="btn" title="Enfocar UD 3">üéØ UD 3</button>

        <button id="btnAutoTour" class="btn auto-tour-btn" title="Tour Curricular Completo">ÔøΩ Tour Curricular</button>
      </div>
      <button id="btnExportPNG" class="btn" title="Exportar PNG">Exportar PNG</button>
      <button id="btnHelp" class="btn" title="Ayuda">Ayuda</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="search">
        <input id="q" placeholder="Buscar (p. ej., 'exploraci√≥n', 'evaluaci√≥n', 'MAG 7,62')" />
        <button id="btnSearch" class="btn">Buscar</button>
      </div>
      <div class="breadcrumbs" id="breadcrumbs">Ruta: <span>Inicio</span></div>
      <div class="legend">
        <div class="tag">Click: expandir/colapsar</div>
        <div class="tag">Ctrl + scroll: zoom</div>
        <div class="tag">Arrastrar: pan</div>
      </div>
      <div class="mini">
        <p><strong>Vista sin√≥ptica:</strong> el diagrama arranca colapsado por niveles. Hac√© zoom para detallar.</p>
        <p>Bot√≥n <em>Foco: UD 3</em> te centra en la Unidad Did√°ctica 3 con animaci√≥n.</p>
      </div>
      <div class="info" id="info">
        <h3>Seleccione un nodo</h3>
        <p>Al hacer click en un nodo, ver√°s aqu√≠ un resumen did√°ctico y puntos clave para la exposici√≥n.</p>
      </div>
    </aside>
    <main>
      <svg id="chart"></svg>
      <div id="minimap" style="position:absolute; right:24px; bottom:80px; width:160px; height:160px; background:#e3eaf7; border:2px solid #4da3ff; border-radius:16px; box-shadow:0 4px 24px rgba(77,163,255,0.18); z-index:10; overflow:hidden;"></div>
      <div class="nav-arrows" style="position:absolute; right:24px; bottom:250px; display:flex; gap:10px;">
        <button id="btnBack" class="btn" title="Volver al nivel anterior">‚¨Ö Volver</button>
        <button id="btnHomeNav" class="btn" title="Ir al inicio">üè† Inicio</button>
      </div>
      <div class="hint">Consejo: empez√° con "Vista general" y luego hac√© foco en UD 3 ‚Üí m√©todos y evaluaci√≥n.</div>
    </main>
  </div>

  <!-- Modo Presentaci√≥n -->
  <div id="presentationMode" class="presentation-mode">
    <div class="presentation-content">
      <button class="close-presentation" onclick="closePresentationMode()">√ó</button>
      <div id="presentationSlide">
        <!-- El contenido de las diapositivas se carga din√°micamente -->
      </div>
      <div class="presentation-nav">
        <button onclick="previousSlide()">‚¨Ö Anterior</button>
        <button onclick="nextSlide()">Siguiente ‚û°</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // 1) Datos jer√°rquicos del proyecto (resumen completo + foco UD3)
    // ==============================
    const data = {
      name: "Proyecto de C√°tedra ‚Äì Conducci√≥n Nivel Secci√≥n (Caballer√≠a)",
      note: "Presentaci√≥n interactiva para Pr√°ctica Supervisada y dictado de la UD 3.",
      children: [
        {
          name: "Informaci√≥n Institucional",
          brief: "Carrera, c√≥digo, carga horaria, resoluci√≥n ministerial.",
          children: [
            { name: "Instituci√≥n", note: "Ej√©rcito Argentino - Colegio Militar de la Naci√≥n" },
            { name: "Carrera", note: "Licenciatura en Conducci√≥n y Gesti√≥n Operativa" },
            { name: "Resoluci√≥n", note: "RESOL-2019-14-APN-MECCYT" },
            { name: "Curso", note: "IVto A√±o ‚Äì Caballer√≠a. C√≥digo: 0-4-55-17" },
            { name: "Carga horaria semanal", note: "5 Hs (60') / 6 Hs (45')" },
            { name: "Carga horaria total", note: "108 Hs (60') / 144 Hs (45')" },
            { name: "Duraci√≥n", note: "Anual" },
            { name: "Car√°cter", note: "Obligatoria" },
            { name: "Plantel docente", note: "Coordinador y Profesores: Ver Plantel Docente" }
          ]
        },
        {
          name: "Perfil por Competencias",
          brief: "√âtica, mando, t√©cnica, pensamiento cr√≠tico, resoluci√≥n de problemas, comunicaci√≥n.",
          children: [
            { name: "√âtica y legalidad", note: "Actuar seg√∫n principios √©ticos y Constituci√≥n." },
            { name: "Mando y disciplina", note: "Subordinaci√≥n, disciplina, liderazgo." },
            { name: "Aplicaci√≥n t√©cnica", note: "Terminolog√≠a, t√©cnicas y procedimientos operacionales." },
            { name: "Pensamiento cr√≠tico", note: "Reflexivo, anal√≠tico e independiente." },
            { name: "Resoluci√≥n de problemas", note: "Anticipar y resolver problemas complejos." },
            { name: "Marco jur√≠dico y cultural", note: "Normas, historia y cultura institucional." },
            { name: "Trabajo en equipo", note: "Coordinaci√≥n por objetivos." },
            { name: "Aprendizaje continuo", note: "Actualizaci√≥n cient√≠fica y tecnol√≥gica." },
            { name: "Funci√≥n p√∫blica", note: "Rol del funcionario militar." },
            { name: "Comunicaci√≥n", note: "Comunicaci√≥n eficaz vertical y horizontal." },
            { name: "Planeamiento t√°ctico", note: "Fundamentos y aplicaci√≥n por nivel." },
            { name: "Tiro", note: "Fundamentos y seguridad de tiro." },
            { name: "Servicios", note: "Normas de seguridad y guarnici√≥n." },
            { name: "Pedagog√≠a", note: "Principios pedag√≥gicos como instructor." },
            { name: "Conducci√≥n t√°ctica", note: "Ejecuci√≥n de operaciones en diferentes armas." }
          ]
        },
        {
          name: "Marco Referencial",
          brief: "Contenidos m√≠nimos, misi√≥n, empleo, conducci√≥n, normas de servicio.",
          children: [
            { name: "Contenidos m√≠nimos", children:[
              { name:"Misi√≥n", note:"Organizaci√≥n, capacidades y limitaciones de la secci√≥n."},
              { name:"Empleo t√°ctico", note:"Planeamiento y ejecuci√≥n de operaciones t√°cticas."},
              { name:"Conducci√≥n", note:"Aplicaci√≥n en ambientes y situaciones particulares."},
              { name:"Normas de servicio", note:"Oficial de servicio, jefe de guardia, seguridad y guarnici√≥n."}
            ]},
            { name: "Prerrequisitos", note: "Conducci√≥n Nivel Grupo (III A√±o)." }
          ]
        },
        {
          name: "Articulaci√≥n",
          brief: "Vinculaci√≥n con T√°ctica Particular, Pr√°ctica Profesional, Did√°ctica, Tecnolog√≠a, EF y Oratoria.",
          children: [
            { name: "T√°ctica Particular", children:[
              { name: "Conceptos del Arma de Caballer√≠a" },
              { name: "Empleo en operaciones t√°cticas" },
              { name: "Log√≠stica en unidad t√°ctica" },
              { name: "Movimientos en el campo t√°ctico" },
              { name: "Ambientes y operaciones particulares" },
              { name: "Tecnolog√≠a en combate moderno" }
            ]},
            { name: "Pr√°ctica Profesional", children:[
              { name: "Proceder del Jefe de Tropas" },
              { name: "Conducci√≥n de secciones" },
              { name: "Secciones semi-independientes" },
              { name: "Armas, materiales y veh√≠culos del Arma" }
            ]},
            { name: "Did√°ctica Especial Militar", children:[
              { name: "Planeamiento de operaciones t√°cticas" },
              { name: "Instructor y Director de ejercicios" }
            ]},
            { name: "Tecnolog√≠a Espec√≠fica", children:[
              { name: "Principios f√≠sicos del material" },
              { name: "Materiales del Arma" },
              { name: "Tendencias" }
            ]},
            { name: "Educaci√≥n F√≠sica", children:[
              { name: "Rol del instructor" },
              { name: "Seguridad en educaci√≥n f√≠sica" },
              { name: "Did√°ctica especial" }
            ]},
            { name: "Oratoria II", children:[
              { name: "Ret√≥rica y oratoria" },
              { name: "Comprensi√≥n lectora" },
              { name: "Redacci√≥n de textos" }
            ]}
          ]
        },
        {
          name: "Encuadre Metodol√≥gico",
          brief: "Prop√≥sitos formativos y metodolog√≠a de ense√±anza-aprendizaje.",
          children: [
            { name: "Prop√≥sitos", children:[
              { name: "Formar al cadete como Jefe de Secci√≥n" },
              { name: "Desarrollar pensamiento reflexivo" },
              { name: "Aprendizaje significativo guiado por Instructor" }
            ]},
            { name: "Metodolog√≠a", children:[
              { name: "T√©cnicas grupales y trabajo en equipo" },
              { name: "Gu√≠as de estudio" },
              { name: "Cartograf√≠a y situaciones t√°cticas" },
              { name: "Teor√≠a + pr√°ctica en campo de instrucci√≥n" }
            ]}
          ]
        },
        {
          name: "Modalidad y Evaluaci√≥n",
          brief: "Criterios de evaluaci√≥n formativa y de desempe√±o.",
          children: [
            { name: "Criterios", children:[
              { name: "Evaluaci√≥n como di√°logo pedag√≥gico" },
              { name: "Valoraci√≥n precisa de resultados" },
              { name: "Competencias profesionales como cierre formativo" }
            ]}
          ]
        },
        {
          name: "Unidades Did√°cticas",
          brief: "UD1 Morteros ¬∑ UD2 Tanques ¬∑ UD3 Exploraci√≥n ¬∑ UD4 Armas combinadas ¬∑ UD5 Teor√≠a General",
          children: [
            {
              name: "UD 1: Conducci√≥n de Secci√≥n Morteros",
              brief: "Fuegos de apoyo. 81/120 mm y VCTM.",
              children:[
                { name:"Enfoque", note:"Planeamiento y ejecuci√≥n de fuegos de apoyo" },
                { name:"Equipos", note:"Mortero 81mm, 120mm, VCTM" },
                { name:"Actividades", children:[
                  { name:"Estudio dirigido" }, { name:"Pr√°ctica gobernada" }, { name:"Ejercicios t√°cticos" }
                ]}
              ]
            },
            {
              name: "UD 2: Conducci√≥n de Secci√≥n Tanques",
              brief: "VC TAM, SK-105. Teor√≠a de tiro y OO.",
              children:[
                { name:"Enfoque", note:"Operaciones de combate con VC TAM y SK 105" },
                { name:"Contenidos", note:"Orden de operaciones, teor√≠a de tiro de tanques" },
                { name:"Actividades", children:[
                  { name:"Ejercicios aplicativos" }, { name:"Soluci√≥n de problemas t√°cticos" }
                ]}
              ]
            },
            {
              name: "UD 3: Conducci√≥n de Secci√≥n Exploraci√≥n",
              brief: "Planeamiento y ejecuci√≥n de exploraci√≥n. M√©todos y evaluaci√≥n (foco).",
              children:[
                { name:"Objetivos de aprendizaje", children:[
                  { name:"Planear y ejecutar operaciones complementarias" },
                  { name:"Conducir exploraci√≥n en veh√≠culo, aeronave o ganado" },
                  { name:"Aplicar teor√≠a y seguridad de tiro con armas port√°tiles y VVCC" }
                ]},
                { name:"Est√°ndares", children:[
                  { name:"Aplica principios y procedimientos de exploraci√≥n" },
                  { name:"Planeamiento l√≥gico con PJT" },
                  { name:"Confecciona e imparte Orden de Operaciones" },
                  { name:"Se desempe√±a como Director de Tiro (armas port√°tiles)" }
                ]},
                { name:"Contenidos", children:[
                  { name:"Conceptos", note:"Principios, misi√≥n, capacidades y organizaci√≥n de la secci√≥n" },
                  { name:"T√°ctica", note:"Operaciones ofensivas, defensivas y complementarias" },
                  { name:"Procedimientos", children:[
                    { name:"Movimientos (a pie y en veh√≠culo)" },
                    { name:"Exploraci√≥n desmontada y montada" },
                    { name:"Reconocimientos" },
                    { name:"Sost√©n log√≠stico" },
                    { name:"Exploraci√≥n en localidades, monta√±a y con ganado" },
                    { name:"Asalto a√©reo y paracaidismo" }
                  ]},
                  { name:"Equipos", children:[
                    { name:"FAL, MAG, Pistola, Escopeta, Ametralladora 12,7mm" },
                    { name:"MK 19, TOW 2, AT4" },
                    { name:"VUG HUMMER, POLARIS, motos 250cc" },
                    { name:"Comunicaciones HF, VHF, UHF" }
                  ]}
                ]},
                { name:"Actividades de ense√±anza", children:[
                  { name:"Exposici√≥n" }, { name:"Estudio dirigido" }, { name:"Pr√°ctica gobernada" }, { name:"Ejercicios aplicativos" }, { name:"Soluci√≥n de temas t√°cticos" }
                ]},
                { name:"M√©todos de ense√±anza (foco)", children:[
                  { name:"Modelo expositivo breve + gu√≠a de estudio" },
                  { name:"Aprendizaje basado en problemas (ABP)" },
                  { name:"T√°cticas de simulaci√≥n (cartograf√≠a / wargame liviano)" },
                  { name:"Pr√°ctica gobernada por estaciones (tiro en seco / comunicaciones)" }
                ]},
                { name:"Evaluaci√≥n (foco)", children:[
                  { name:"Formativa: lista de cotejo en pr√°cticas" },
                  { name:"Sumativa: trabajo pr√°ctico + parcial oral OO" },
                  { name:"Desempe√±o: rol como Jefe de Secci√≥n en caso t√°ctico" }
                ]},
                { name:"Bibliograf√≠a obligatoria", children:[
                  { name:"ROP-00-15 (2018) La Secci√≥n Exploraci√≥n" },
                  { name:"RFP-79-01 (2017) Tiro con armas port√°tiles" },
                  { name:"RFP-24-02 (2012) Ganado en Servicio" },
                  { name:"RFP-79-35 (2022) Tiro con MAG 7,62mm" },
                  { name:"Manual T√©cnico HUMMER, POLARIS, TOW 2, AT4" }
                ]}
              ]
            },
            {
              name: "UD 4: Secciones en Armas Combinadas",
              brief: "Interoperabilidad con otras armas y apoyos.",
              children:[
                { name:"Enfoque", note:"Interoperabilidad con Inf, Art, Ing, Com, Av, Int" },
                { name:"Actividades", note:"Operaciones combinadas, log√≠stica, movilidad/contramovilidad" }
              ]
            },
            {
              name: "UD 5: Teor√≠a General",
              brief: "Servicio interno, guarnici√≥n, disciplina, documentaci√≥n.",
              children:[
                { name:"Enfoque", note:"Servicio interno, normas y documentaci√≥n" },
                { name:"Actividades", note:"Ejercicios aplicativos y discusi√≥n guiada" }
              ]
            }
          ]
        },
        { name: "Infraestructura", note: "Aulas, gabinetes, anfiteatros y Pabell√≥n de Estudios" }
      ]
    };

    // ==============================
    // 2) D3: Configuraci√≥n base (radial, zoom, pan)
    // ==============================
    const svg = d3.select('#chart');
    const g = svg.append('g'); // viewport zoomable

    const width = () => document.querySelector('main').clientWidth;
    const height = () => document.querySelector('main').clientHeight;

    function resize(){ 
      const w = width();
      const h = height();
      svg.attr('width', w).attr('height', h);
      // Centrar el grupo g en el centro del viewport
      g.attr('transform', `translate(${w/2}, ${h/2})`);
      console.log(`SVG resized to ${w}x${h}, g centered at (${w/2}, ${h/2})`);
    }
    window.addEventListener('resize', () => { resize(); centerRoot(); });
    resize();

    const zoom = d3.zoom()
      .scaleExtent([0.1, 2.5]) // Permitir zoom m√°s peque√±o
      .on('zoom', (event) => {
        // Solo aplicar zoom y pan, mantener centrado base
        const transform = event.transform;
        g.attr('transform', `translate(${width()/2 + transform.x}, ${height()/2 + transform.y}) scale(${transform.k})`);
      });
    svg.call(zoom)
      .on("dblclick.zoom", null) // Deshabilitar doble click zoom
      .on("wheel.zoom", function(event) {
        // Zoom centrado en la posici√≥n del mouse
        event.preventDefault();
        const [mouseX, mouseY] = d3.pointer(event);
        const transform = d3.zoomTransform(this);
        const k = transform.k * Math.pow(2, -event.deltaY * 0.002);
        const newK = Math.max(0.1, Math.min(2.5, k));
        
        // Calcular nueva transformaci√≥n centrada en el mouse
        const x = mouseX - width()/2;
        const y = mouseY - height()/2;
        const newTransform = d3.zoomIdentity
          .translate(-x * (newK / transform.k - 1), -y * (newK / transform.k - 1))
          .scale(newK)
          .translate(transform.x, transform.y);
        
        d3.select(this).call(zoom.transform, newTransform);
      });

    // Layout radial adaptativo con mucho m√°s espacio
  const radialLayout = d3.cluster().size([2 * Math.PI, Math.min(width(), height())/2 - 60]);
  function getRadialLayout(node) {
    const baseRadius = Math.min(width(), height())/2 - 40; // M√°s espacio disponible
    const n = (node.children||[]).length;
    
    // Radios mucho m√°s grandes para evitar superposici√≥n completa
    let maxRadius;
    if (n > 8) {
      maxRadius = baseRadius * 2.5; // 5 veces m√°s espacio
    } else if (n > 5) {
      maxRadius = baseRadius * 2.2;
    } else {
      maxRadius = baseRadius * 2.0;
    }
    
    return d3.cluster().size([2 * Math.PI, maxRadius]);
  }
  let mainRoot = d3.hierarchy(data, d => d.children);
  let root = mainRoot;

    // Inicial: colapsar todo salvo primer nivel
    root.x0 = height()/2; root.y0 = 0;
    root.children?.forEach(collapseAll);

    function collapseAll(d){
      if(d.children){ d._children = d.children; d._children.forEach(collapseAll); d.children = null; }
    }

    // Minimapa radial
    function renderMinimap(){
      try {
        const mm = d3.select('#minimap');
        mm.selectAll('*').remove();
        const w = 160, h = 160, r = 50;
        const svgMM = mm.append('svg').attr('width',w).attr('height',h);
        const gMM = svgMM.append('g').attr('transform',`translate(${w/2},${h/2})`);
        
        // Layout minimapa mostrando SOLO la estructura del nivel actual (root)
        const miniRoot = root.copy();
        d3.cluster().size([2*Math.PI, r])(miniRoot);
        
        // Paleta de colores
        const levelColors = ["#e3eaf7", "#ffd34d", "#4da3ff", "#54d17a", "#ff6b6b", "#f6f8fa", "#b3c2db"];
        
        // Links del nivel actual
        if(miniRoot.links().length > 0) {
          gMM.selectAll('path').data(miniRoot.links()).join('path')
            .attr('d', d => {
              const a1 = d.source.x - Math.PI/2, a2 = d.target.x - Math.PI/2;
              const x1 = Math.cos(a1)*d.source.y, y1 = Math.sin(a1)*d.source.y;
              const x2 = Math.cos(a2)*d.target.y, y2 = Math.sin(a2)*d.target.y;
              return `M${x1},${y1}L${x2},${y2}`;
            })
            .attr('stroke','#4da3ff')
            .attr('fill','none')
            .attr('stroke-width', 1.5)
            .attr('opacity', 0.7);
        }
        
        // Nodos del nivel actual
        gMM.selectAll('circle').data(miniRoot.descendants()).join('circle')
          .attr('cx', d => Math.cos(d.x-Math.PI/2)*d.y)
          .attr('cy', d => Math.sin(d.x-Math.PI/2)*d.y)
          .attr('r', d => {
            if(d.depth === 0) return 8;
            if(d.depth === 1) return 6;
            return Math.max(3, 7 - d.depth);
          })
          .attr('fill', d => levelColors[d.depth % levelColors.length])
          .attr('stroke', '#232b3e')
          .attr('stroke-width', 1)
          .attr('opacity', 0.9);
          
        // T√≠tulo del minimapa indicando el contexto con jerarqu√≠a
        const isSubLevel = root !== mainRoot;
        const breadcrumbPath = [];
        let current = root;
        while(current && current !== mainRoot) {
          breadcrumbPath.unshift(current.data.name);
          current = current.parent;
        }
        
        let titleText = root.data.name;
        if(breadcrumbPath.length > 1) {
          titleText = `.../${breadcrumbPath[breadcrumbPath.length-1]}`;
        }
        
        gMM.append('text')
          .attr('x', 0)
          .attr('y', -r - 10)
          .attr('text-anchor', 'middle')
          .attr('font-size', '10px')
          .attr('fill', isSubLevel ? '#ff6b6b' : '#4da3ff')
          .attr('font-weight', 'bold')
          .text(titleText.length > 25 ? 
            titleText.substring(0, 25) + "..." : 
            titleText);
            
        // Indicador de navegaci√≥n con profundidad
        if(isSubLevel) {
          const depth = breadcrumbPath.length;
          gMM.append('circle')
            .attr('cx', r - 8)
            .attr('cy', -r + 8)
            .attr('r', 4)
            .attr('fill', '#ff6b6b')
            .attr('stroke', '#fff')
            .attr('stroke-width', 1);
            
          // Mostrar nivel de profundidad
          gMM.append('text')
            .attr('x', r - 8)
            .attr('y', -r + 12)
            .attr('text-anchor', 'middle')
            .attr('font-size', '8px')
            .attr('fill', '#fff')
            .attr('font-weight', 'bold')
            .text(depth);
        }
            
      } catch(error) {
        console.warn('Error renderizando minimapa:', error);
      }
    }

    // Navegaci√≥n por niveles con stack
    let navigationStack = [mainRoot];

    document.getElementById('btnBack').onclick = () => {
      // Volver al nivel anterior en el stack
      if(navigationStack.length > 1) {
        navigationStack.pop(); // remover el actual
        const previousRoot = navigationStack[navigationStack.length - 1];
        root = previousRoot;
        
        // Colapsar todos los hijos al volver para vista limpia
        if(root.children) {
          root.children.forEach(child => {
            if(child.children) {
              collapseDeep(child);
            }
          });
        }
        
        update(root);
        centerRoot();
        showInfo(root);
        updateBreadcrumbs(root);
      }
    };
    document.getElementById('btnHomeNav').onclick = () => {
      // Volver al inicio y resetear stack
      navigationStack = [mainRoot];
      root = mainRoot;
      
      // Colapsar todo excepto primer nivel
      if(root.children) {
        root.children.forEach(collapseDeep);
      }
      
      update(root);
      centerRoot();
      showInfo(root);
      updateBreadcrumbs(root);
    };

    // Mantener rastro de √∫ltimo foco para breadcrumbs
    let lastFocused = root;

    // ==============================
    // 3) Render + animaciones
    // ==============================
    function update(source){
  // Paleta de colores por nivel
  const levelColors = ["#e3eaf7", "#ffd34d", "#4da3ff", "#54d17a", "#ff6b6b", "#f6f8fa", "#b3c2db"];
      const duration = 500;
      const nodes = root.descendants();
      const links = root.links();

      // Layout radial adaptativo con anillos para niveles profundos
      const layout = getRadialLayout(root);
      layout(root);
      
      // Ajustar distribuci√≥n angular y crear anillos conc√©ntricos con mucho m√°s espacio
      root.descendants().forEach(d => {
        if (d.children && d.children.length > 0) {
          const childCount = d.children.length;
          
          // Espaciado masivo para niveles profundos
          const baseRadius = d.y || 0;
          const ringSpacing = Math.max(300, 200 + childCount * 25); // 5x m√°s espaciado
          const ringRadius = baseRadius + ringSpacing;
          
          // Usar todo el c√≠rculo disponible con m√°s separaci√≥n angular
          const angleStep = (2 * Math.PI) / childCount;
          const angleOffset = Math.PI / (childCount * 2); // Mejor distribuci√≥n
          
          d.children.forEach((child, i) => {
            // Distribuir uniformemente con offset
            child.x = (i * angleStep) + angleOffset;
            // Colocar en anillo correspondiente - permitir salir del viewport si es necesario
            child.y = ringRadius;
          });
        }
      });

      // ------- LINKS --------
      const link = g.selectAll('path.link').data(links, d => d.target.id || (d.target.id = crypto.randomUUID()));
      link.join(
        enter => enter.append('path')
          .attr('class', 'link')
          .attr('d', d => radialDiagonal({source: source, target: source}))
          .transition().duration(duration)
          .attr('d', radialDiagonal),
        update => update.transition().duration(duration).attr('d', radialDiagonal),
        exit => exit.transition().duration(duration)
          .attr('d', d => radialDiagonal({source: source, target: source}))
          .remove()
      );

      // ------- NODES --------
      const node = g.selectAll('g.node').data(nodes, d => d.id || (d.id = crypto.randomUUID()));

      const nodeEnter = node.enter().append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${polarToCartesian(source.x0, source.y0)})`)
        .on('click', (event, d) => toggle(d))
        .on('mouseenter', (event, d) => showInfo(d))
        .on('mouseleave', () => { /* keep info persistent after click */ });

      // Contenedor con tama√±os que realmente contengan el texto
      nodeEnter.append('rect')
        .attr('width', d => d.depth > 2 ? 240 : 300)
        .attr('height', d => d.depth > 2 ? 55 : 70)
        .attr('x', d => d.depth > 2 ? -120 : -150)
        .attr('y', d => d.depth > 2 ? -27.5 : -35);

      nodeEnter.append('text')
        .attr('dy', -8)
        .text(d => {
          // Truncar texto largo para nodos profundos
          const maxLength = d.depth > 2 ? 32 : 45;
          return d.data.name.length > maxLength ? 
            d.data.name.substring(0, maxLength) + "..." : 
            d.data.name;
        })
        .attr('x', 0)
        .attr('text-anchor','middle')
        .attr('font-size', d => d.depth > 2 ? '16px' : '18px')
        .attr('font-weight', 'bold');

      // brief / nota peque√±a (solo para niveles no muy profundos)
      nodeEnter.filter(d => d.depth <= 2)
        .append('text').attr('class','small').attr('dy', 25).attr('x', 0).attr('text-anchor','middle')
        .text(d => {
          const brief = d.data.brief || d.data.note || "";
          return brief.length > 50 ? brief.substring(0, 50) + "..." : brief;
        });

      // pill de tipo (hoja / tiene hijos) - posici√≥n ajustada a contenedores m√°s grandes
      nodeEnter.filter(d => (d.children || d._children)).append('rect')
        .attr('class','pill')
        .attr('x', d => d.depth > 2 ? 105 : 135)
        .attr('y', -25)
        .attr('width', 24).attr('height', 20);
      nodeEnter.filter(d => (d.children || d._children)).append('text')
        .attr('class','pillText')
        .attr('x', d => d.depth > 2 ? 117 : 147)
        .attr('y', -11)
        .text('‚Æü');

      // Chevron a la izquierda - posici√≥n ajustada a contenedores m√°s grandes
      nodeEnter.append('text').attr('class','chev')
        .attr('x', d => d.depth > 2 ? -135 : -165)
        .attr('y', 5).text('‚ñ∂');

      const nodeUpdate = nodeEnter.merge(node);

      nodeUpdate.transition().duration(duration)
        .attr('transform', d => `translate(${polarToCartesian(d.x, d.y)})`)
        .select('rect')
        .attr('fill', d => levelColors[d.depth % levelColors.length]);

      nodeUpdate.select('.chev').text(d => (d.children ? '‚ñº' : (d._children ? '‚ñ∂' : '‚Ä¢')))
        .attr('fill', d => d.children ? '#4da3ff' : (d._children ? '#ffd34d' : '#7a8ca5'));

      node.exit().transition().duration(duration)
        .attr('transform', d => `translate(${polarToCartesian(source.x, source.y)})`).remove();

      // Guardar posiciones para transiciones
      nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
    }

    // Integrar minimapa con update
    const originalUpdate = update;
    update = function(source) {
      originalUpdate(source);
      renderMinimap();
    };

    // Utilidad para convertir coordenadas polares a cartesianas
    function polarToCartesian(angle, radius){
      const r = radius, a = angle - Math.PI/2;
      const x = Math.cos(a) * r;
      const y = Math.sin(a) * r;
      return `${x},${y}`;
    }

    // Diagonal radial para los links
    function radialDiagonal(d){
      const s = polarToCartesian(d.source.x, d.source.y);
      const t = polarToCartesian(d.target.x, d.target.y);
      return `M${s}L${t}`;
    }

    function diagonal(d){
      const path = d3.linkHorizontal().x(d => d.y).y(d => d.x);
      return path(d);
    }

    function toggle(d){
      if(d.children){ 
        // Colapsar nodo
        d._children = d.children; 
        d.children = null; 
      }
      else if(d._children){ 
        // Expandir nodo y colapsar hermanos para evitar superposici√≥n
        if(d.parent && d.parent.children) {
          d.parent.children.forEach(sibling => {
            if(sibling !== d && sibling.children) {
              sibling._children = sibling.children;
              sibling.children = null;
            }
          });
        }
        
        d.children = d._children; 
        d._children = null; 
        lastFocused = d; 
        
        // Para nodos con m√°s de 3 hijos, crear nueva vista centrada
        const childCount = (d.children || []).length;
        if(childCount > 3 || d.depth > 1) {
          // Agregar al stack de navegaci√≥n
          navigationStack.push(root);
          
          // Cambiar root pero mantener la estructura original
          root = d;
          
          // Solo colapsar los nietos (hijos de los hijos) para una vista limpia
          if(root.children) {
            root.children.forEach(child => {
              if(child.children) {
                child._children = child.children;
                child.children = null;
              }
            });
          }
          
          centerRoot();
        } else {
          // Para pocos hijos, solo centrar en el nodo
          const zoomScale = 0.9;
          centerOnNode(d, 600, zoomScale);
        }
      }
      
      update(root);
      showInfo(d);
      updateBreadcrumbs(d);
    }

    // ==============================
    // 4) Utilidades de vista
    // ==============================
    function centerRoot(){ 
      // Resetear zoom con escala que permita ver el contenido completo
      const t = d3.zoomIdentity.scale(0.6);
      svg.call(zoom.transform, t);
      updateBreadcrumbs(root); 
      showInfo(root); 
    }

    function centerOnNode(d, ms=500, scale=1){
      // Centrar en nodo espec√≠fico
      const nodeX = Math.cos(d.x - Math.PI/2) * d.y;
      const nodeY = Math.sin(d.x - Math.PI/2) * d.y;
      
      // Aplicar transformaci√≥n para centrar el nodo
      const t = d3.zoomIdentity.translate(-nodeX, -nodeY).scale(scale);
      svg.transition().duration(ms).call(zoom.transform, t);
    }

    function expandAll(d){
      if(d._children){ d.children = d._children; d._children = null; }
      if(d.children){ d.children.forEach(expandAll); }
    }
    function collapseDeep(d){
      if(d.children){ d.children.forEach(collapseDeep); d._children = d.children; d.children = null; }
    }

    document.getElementById('btnExpand').onclick = () => { expandAll(root); update(root); };
    document.getElementById('btnCollapse').onclick = () => { root.children?.forEach(collapseDeep); update(root); };
    document.getElementById('btnHome').onclick = () => {
      // Volver al root original y colapsar todo excepto el primer nivel
      root = mainRoot;
      root.children?.forEach(collapseDeep);
      update(root);
      centerRoot();
    };

    // Foco UD3 - navegaci√≥n inteligente hacia UD 3
    document.getElementById('btnFocusUD3').onclick = () => {
      console.log("Iniciando b√∫squeda de UD 3...");
      
      // Buscar UD 3 con m√∫ltiples criterios
      const ud3 = mainRoot.descendants().find(n => {
        const name = (n.data.name || "").toLowerCase();
        const match = name.includes("ud 3") || 
                     name.includes("unidad 3") || 
                     name.includes("conducci√≥n de secci√≥n") ||
                     name.includes("exploraci√≥n");
        console.log("Revisando nodo:", n.data.name, "Match:", match);
        return match;
      });
      
      console.log("UD 3 encontrado:", ud3);
      
      if(ud3){
        console.log("Navegando a UD 3:", ud3.data.name);
        
        // Usar la funci√≥n toggle directamente (simular click)
        toggle(ud3);
        
        // Mostrar mensaje de √©xito
        setTimeout(() => {
          alert(`‚úÖ UD 3 encontrado: "${ud3.data.name}"`);
        }, 1000);
      } else {
        // Debug detallado
        console.log("=== DEBUG: Todos los nodos disponibles ===");
        mainRoot.descendants().forEach((n, i) => {
          console.log(`${i}: "${n.data.name}" (depth: ${n.depth})`);
        });
        alert("‚ùå UD 3 no encontrado. Revisa la consola para ver todos los nodos disponibles.");
      }
    };

    // Export PNG (simple): usa foreignObject para rasterizar
    document.getElementById('btnExportPNG').onclick = () => exportPNG();
    function exportPNG(){
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svg.node());
      const canvas = document.createElement('canvas');
      canvas.width = width(); canvas.height = height();
      const ctx = canvas.getContext('2d');
      const img = new Image();
      const blob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      img.onload = () => { ctx.drawImage(img, 0, 0); URL.revokeObjectURL(url); const a = document.createElement('a'); a.download = 'proyecto-catedra.png'; a.href = canvas.toDataURL('image/png'); a.click(); };
      img.src = url;
    }

    // ==============================
    // 5) B√∫squeda sencilla
    // ==============================
    function search(term){
      const t = term.trim().toLowerCase();
      if(!t){ showInfo(lastFocused); updateBreadcrumbs(lastFocused); return; }
      const match = root.descendants().find(n => (n.data.name+" "+(n.data.brief||" ")+ (n.data.note||"")).toLowerCase().includes(t));
      if(match){
        // Abrir todos los ancestros
        let curr = match.parent; while(curr){ if(curr._children){ curr.children = curr._children; curr._children = null; } curr = curr.parent; }
        update(match);
        centerOnNode(match, 600, 1.2);
        showInfo(match);
        updateBreadcrumbs(match);
      }
    }
    document.getElementById('btnSearch').onclick = () => search(document.getElementById('q').value);
    document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(e.target.value); });

    // ==============================
    // 6) Breadcrumbs + panel informativo (resumen did√°ctico)
    // ==============================
    function updateBreadcrumbs(d){
      const trail = d.ancestors().reverse().map(n=>n.data.name);
      document.getElementById('breadcrumbs').innerHTML = 'Ruta: ' + trail.map((t,i)=> i<trail.length-1? `<span>${t}</span> ‚Ä∫ `: `<span>${t}</span>`).join('');
    }

    function showInfo(d){
      lastFocused = d;
      const el = document.getElementById('info');
      const title = d.data.name;
      const brief = d.data.brief || d.data.note || '';
      const hasChildren = (d.children||d._children||[]).length>0;
      let list = '';
      const items = (d.children||d._children||[]).slice(0,8).map(n=>`<li>${n.data.name}</li>`).join('');
      if(items) list = `<ul>${items}</ul>`;
      el.innerHTML = `<h3>${title}</h3><p>${brief}</p>${list}`;
    }

    // ==============================
    // 7) Ayuda
    // ==============================
    document.getElementById('btnHelp').onclick = () => {
      alert(`Gu√≠a r√°pida:\n\n‚Ä¢ Click en un nodo: abre/cierra y centra.\n‚Ä¢ Ctrl + rueda: zoom. Arrastrar: pan.\n‚Ä¢ Vista general: centra el diagrama y muestra la estructura maestra.\n‚Ä¢ Foco UD 3: salta a la unidad que vas a impartir (m√©todos y evaluaci√≥n).\n‚Ä¢ Buscar: encuentra y centra el primer nodo que coincida.\n‚Ä¢ Exportar PNG: guarda una captura de la vista actual.`);
    };

    // ==============================
    // 9) Modo Presentaci√≥n
    // ==============================
    let currentSlide = 0;
    const presentationSlides = [
      {
        title: "Conducci√≥n Nivel Secci√≥n (Caballer√≠a)",
        content: `
          <h2>Proyecto de C√°tedra</h2>
          <p>Presentaci√≥n interactiva para Pr√°ctica Supervisada y dictado de la UD 3.</p>
          <p><strong>Objetivo:</strong> Formar oficiales capaces de conducir una secci√≥n de exploraci√≥n en operaciones t√°cticas.</p>
        `
      },
      {
        title: "Perfil por Competencias",
        content: `
          <h2>Competencias Clave</h2>
          <p><strong>‚Ä¢ √âtica y legalidad:</strong> Actuar seg√∫n principios √©ticos y Constituci√≥n</p>
          <p><strong>‚Ä¢ Mando y disciplina:</strong> Subordinaci√≥n, disciplina, liderazgo</p>
          <p><strong>‚Ä¢ Pensamiento cr√≠tico:</strong> Reflexivo, anal√≠tico e independiente</p>
          <p><strong>‚Ä¢ Aplicaci√≥n t√©cnica:</strong> Terminolog√≠a, t√©cnicas y procedimientos operacionales</p>
          <p><strong>‚Ä¢ Comunicaci√≥n:</strong> Comunicaci√≥n eficaz vertical y horizontal</p>
        `
      },
      {
        title: "UD 3: Est√°ndares de Rendimiento",
        content: `
          <h2>Lo que el alumno debe lograr</h2>
          <p><strong>‚Ä¢ Principios de exploraci√≥n:</strong> Aplica procedimientos correctos</p>
          <p><strong>‚Ä¢ Planeamiento l√≥gico:</strong> Utiliza el Proceso de Juicio T√°ctico (PJT)</p>
          <p><strong>‚Ä¢ Orden de Operaciones:</strong> Confecciona e imparte correctamente</p>
          <p><strong>‚Ä¢ Director de Tiro:</strong> Se desempe√±a con armas port√°tiles</p>
        `
      },
      {
        title: "M√©todos de Ense√±anza Innovadores",
        content: `
          <h2>Enfoque Pedag√≥gico Moderno</h2>
          <p><strong>‚Ä¢ Modelo expositivo breve + gu√≠a de estudio:</strong> Teor√≠a dirigida</p>
          <p><strong>‚Ä¢ Aprendizaje basado en problemas (ABP):</strong> Casos reales</p>
          <p><strong>‚Ä¢ T√°cticas de simulaci√≥n:</strong> Cartograf√≠a y wargaming liviano</p>
          <p><strong>‚Ä¢ Pr√°ctica gobernada por estaciones:</strong> Tiro en seco y comunicaciones</p>
        `
      },
      {
        title: "Sistema de Evaluaci√≥n",
        content: `
          <h2>Evaluaci√≥n Integral</h2>
          <p><strong>‚Ä¢ Formativa:</strong> Lista de cotejo en pr√°cticas</p>
          <p><strong>‚Ä¢ Sumativa:</strong> Trabajo pr√°ctico + parcial oral de Orden de Operaciones</p>
          <p><strong>‚Ä¢ Desempe√±o:</strong> Rol como Jefe de Secci√≥n en caso t√°ctico</p>
          <p>La evaluaci√≥n es continua y se centra en competencias operacionales.</p>
        `
      }
    ];

    function openPresentationMode() {
      currentSlide = 0;
      document.getElementById('presentationMode').style.display = 'flex';
      showSlide(currentSlide);
    }

    function closePresentationMode() {
      document.getElementById('presentationMode').style.display = 'none';
    }

    function showSlide(index) {
      const slide = presentationSlides[index];
      document.getElementById('presentationSlide').innerHTML = `
        <h1 class="presentation-title">${slide.title}</h1>
        ${slide.content}
      `;
    }

    function nextSlide() {
      if (currentSlide < presentationSlides.length - 1) {
        currentSlide++;
        showSlide(currentSlide);
      }
    }

    function previousSlide() {
      if (currentSlide > 0) {
        currentSlide--;
        showSlide(currentSlide);
      }
    }

    // Conectar bot√≥n de tour
    document.getElementById('btnAutoTour').onclick = startAutoTour;

    // ==============================
    // Tour Curricular Completo - Presentaci√≥n sistem√°tica del proyecto
    // ==============================
    let isAutoTourRunning = false;
    let tourTimeout = null;
    let currentTourStep = 0;
    
    const tourSteps = [
      // INTRODUCCI√ìN GENERAL
      {
        description: "Proyecto de C√°tedra: Conducci√≥n Nivel Secci√≥n (Caballer√≠a)",
        focus: null,
        action: "overview",
        duration: 0, // Manual
        notes: "Presentaci√≥n general del proyecto curricular"
      },
      
      // INFORMACI√ìN INSTITUCIONAL
      {
        description: "1. Informaci√≥n Institucional",
        focus: "Informaci√≥n Institucional",
        action: "highlight",
        duration: 0,
        notes: "Marco institucional: carrera, resoluci√≥n, carga horaria"
      },
      {
        description: "1.1 Instituci√≥n y Carrera",
        focus: "Carrera",
        action: "highlight",
        duration: 0,
        notes: "Licenciatura en Conducci√≥n y Gesti√≥n Operativa - RESOL-2019-14-APN-MECCYT"
      },
      {
        description: "1.2 C√≥digo y Carga Horaria",
        focus: "Carga horaria total",
        action: "highlight",
        duration: 0,
        notes: "IVto A√±o Caballer√≠a - 108/144 horas anuales seg√∫n modalidad"
      },
      
      // PERFIL POR COMPETENCIAS
      {
        description: "2. Perfil por Competencias - Marco General",
        focus: "Perfil por Competencias",
        action: "highlight",
        duration: 0,
        notes: "15 competencias transversales que desarrollar√°n los cadetes"
      },
      {
        description: "2.1 √âtica y legalidad",
        focus: "√âtica y legalidad", 
        action: "highlight",
        duration: 0,
        notes: "Actuar seg√∫n principios √©ticos y Constituci√≥n"
      },
      {
        description: "2.2 Mando y disciplina",
        focus: "Mando y disciplina",
        action: "highlight", 
        duration: 0,
        notes: "Subordinaci√≥n, disciplina, liderazgo"
      },
      {
        description: "2.3 Aplicaci√≥n t√©cnica",
        focus: "Aplicaci√≥n t√©cnica",
        action: "highlight",
        duration: 0,
        notes: "Terminolog√≠a, t√©cnicas y procedimientos operacionales"
      },
      {
        description: "2.4 Pensamiento cr√≠tico",
        focus: "Pensamiento cr√≠tico", 
        action: "highlight",
        duration: 0,
        notes: "Reflexivo, anal√≠tico e independiente"
      },
      {
        description: "2.5 Comunicaci√≥n",
        focus: "Comunicaci√≥n",
        action: "highlight",
        duration: 0,
        notes: "Comunicaci√≥n eficaz vertical y horizontal"
      },
      {
        description: "‚Üí Cerrando secci√≥n: Perfil por Competencias",
        focus: "Perfil por Competencias",
        action: "close",
        duration: 0,
        notes: "Finalizamos la revisi√≥n de competencias"
      },
      
      // MARCO REFERENCIAL
      {
        description: "3. Marco Referencial",
        focus: "Marco Referencial",
        action: "highlight",
        duration: 0,
        notes: "Contenidos m√≠nimos, misi√≥n, empleo, conducci√≥n, normas"
      },
      {
        description: "3.1 Contenidos m√≠nimos",
        focus: "Contenidos m√≠nimos",
        action: "highlight",
        duration: 0,
        notes: "Misi√≥n, empleo t√°ctico, conducci√≥n, normas de servicio"
      },
      {
        description: "3.2 Prerrequisitos acad√©micos",
        focus: "Prerrequisitos",
        action: "highlight", 
        duration: 0,
        notes: "Conducci√≥n Nivel Grupo (III A√±o)"
      },
      
      // ARTICULACI√ìN
      {
        description: "4. Articulaci√≥n Curricular",
        focus: "Articulaci√≥n",
        action: "highlight",
        duration: 0,
        notes: "Vinculaci√≥n con otras materias del plan de estudios"
      },
      
      // UNIDAD DID√ÅCTICA 3 - FOCO PRINCIPAL
      {
        description: "5. UD 3: Conducci√≥n de Secci√≥n Exploraci√≥n - LA UNIDAD QUE VOY A DICTAR",
        focus: "UD 3: Conducci√≥n de Secci√≥n Exploraci√≥n",
        action: "highlight",
        duration: 0,
        notes: "Esta es la unidad espec√≠fica que impartir√© en clase"
      },
      {
        description: "4.1 Objetivos de aprendizaje",
        focus: "Objetivos de aprendizaje",
        action: "highlight",
        duration: 0,
        notes: "Qu√© deben lograr los cadetes al finalizar"
      },
      {
        description: "4.2 Est√°ndares de rendimiento - INDICADORES DE LOGRO",
        focus: "Est√°ndares",
        action: "highlight",
        duration: 0,
        notes: "C√≥mo eval√∫o que alcanzaron los objetivos"
      },
      {
        description: "4.3 Contenidos conceptuales",
        focus: "Contenidos",
        action: "highlight",
        duration: 0,
        notes: "Principios, misi√≥n, capacidades, organizaci√≥n, t√°ctica"
      },
      {
        description: "4.4 Procedimientos operacionales",
        focus: "Procedimientos",
        action: "highlight",
        duration: 0,
        notes: "Movimientos, exploraci√≥n, reconocimientos, log√≠stica"
      },
      {
        description: "4.5 Equipos y material",
        focus: "Equipos",
        action: "highlight",
        duration: 0,
        notes: "Armamento, veh√≠culos, comunicaciones"
      },
      {
        description: "4.6 Actividades de ense√±anza - C√ìMO ENSE√ëO",
        focus: "Actividades de ense√±anza",
        action: "highlight",
        duration: 0,
        notes: "Exposici√≥n, estudio dirigido, pr√°ctica, ejercicios"
      },
      {
        description: "4.7 M√©todos pedag√≥gicos - HERRAMIENTAS DID√ÅCTICAS",
        focus: "M√©todos de ense√±anza (foco)",
        action: "highlight",
        duration: 0,
        notes: "ABP, simulaci√≥n, pr√°ctica por estaciones"
      },
      {
        description: "4.8 Sistema de evaluaci√≥n - C√ìMO EVAL√öO",
        focus: "Evaluaci√≥n (foco)",
        action: "highlight",
        duration: 0,
        notes: "Formativa, sumativa, desempe√±o en rol"
      },
      {
        description: "4.9 Bibliograf√≠a obligatoria",
        focus: "Bibliograf√≠a obligatoria",
        action: "highlight",
        duration: 0,
        notes: "Reglamentos y manuales de referencia"
      },
      
      // OTRAS UNIDADES (contexto)
      {
        description: "6. Contexto: UD 1 - Principios generales",
        focus: "UD 1",
        action: "highlight",
        duration: 0,
        notes: "Marco general que antecede a mi unidad"
      },
      {
        description: "7. Contexto: UD 2 - Veh√≠culos de combate",
        focus: "UD 2",
        action: "highlight", 
        duration: 0,
        notes: "Contenidos t√©cnicos complementarios"
      },
      
      // INFRAESTRUCTURA
      {
        description: "8. Recursos e infraestructura",
        focus: "Infraestructura",
        action: "highlight",
        duration: 0,
        notes: "Espacios f√≠sicos y recursos disponibles"
      },
      
      // S√çNTESIS FINAL
      {
        description: "S√≠ntesis: Contribuci√≥n de UD 3 al perfil de egreso",
        focus: null,
        action: "overview",
        duration: 0,
        notes: "C√≥mo mi clase contribuye a formar al oficial de caballer√≠a"
      }
    ];

    function startAutoTour() {
      if(isAutoTourRunning) {
        stopAutoTour();
        return;
      }
      
      isAutoTourRunning = true;
      currentTourStep = 0;
      document.getElementById('btnAutoTour').textContent = '‚èπ Finalizar Tour';
      document.getElementById('btnAutoTour').style.background = '#ff6b6b';
      
      // Reset completo y limpio al inicio
      root = mainRoot;
      navigationStack = [mainRoot];
      
      // Colapsar todo de manera ordenada
      function collapseAll(node) {
        if(node.children) {
          node.children.forEach(child => {
            collapseAll(child);
            if(child.children) {
              child._children = child.children;
              child.children = null;
            }
          });
        }
      }
      
      collapseAll(mainRoot);
      update(root);
      centerRoot();
      
      // Esperar un momento antes de iniciar para que se vea el reset
      setTimeout(() => {
        executeTourStep(0);
      }, 500);
    }

    function stopAutoTour() {
      isAutoTourRunning = false;
      if(tourTimeout) {
        clearTimeout(tourTimeout);
        tourTimeout = null;
      }
      document.getElementById('btnAutoTour').textContent = 'Tour Curricular';
      document.getElementById('btnAutoTour').style.background = '#54d17a';
      
      // Ocultar mensaje de tour
      const tourMessage = document.getElementById('tourMessage');
      if(tourMessage) tourMessage.remove();
    }

    function executeTourStep(stepIndex) {
      if(!isAutoTourRunning || stepIndex >= tourSteps.length) {
        stopAutoTour();
        showTourMessage("¬°Presentaci√≥n curricular completada!", tourSteps.length, tourSteps.length);
        setTimeout(() => {
          const tourMessage = document.getElementById('tourMessage');
          if(tourMessage) tourMessage.remove();
        }, 4000);
        return;
      }
      
      const step = tourSteps[stepIndex];
      currentTourStep = stepIndex;
      
      // Mostrar mensaje con informaci√≥n pedag√≥gica
      showTourMessage(step.description, stepIndex + 1, tourSteps.length, step.notes);
      
      // Ejecutar acci√≥n (ahora S√ç navega autom√°ticamente)
      if(step.action === "highlight" && step.focus) {
        navigateAndHighlight(step.focus);
      } else if(step.action === "overview") {
        // Volver al inicio con animaci√≥n suave
        root = mainRoot;
        navigationStack = [mainRoot];
        
        // Colapsar todo gradualmente
        function collapseAll(node) {
          if(node.children) {
            node.children.forEach(child => {
              collapseAll(child);
              if(child.children) {
                child._children = child.children;
                child.children = null;
              }
            });
          }
        }
        
        collapseAll(mainRoot);
        update(root);
        centerRoot();
      }
    }

    function navigateAndHighlight(targetName) {
      const target = mainRoot.descendants().find(n => 
        (n.data.name || "").includes(targetName)
      );
      
      if(target) {
        // Primero, navegar hasta hacer el target visible
        function makeTargetVisible() {
          const path = [];
          let curr = target;
          while(curr && curr !== mainRoot) {
            path.unshift(curr);
            curr = curr.parent;
          }
          
          // Expandir solo lo necesario para hacer visible el target
          let currentNode = mainRoot;
          for(let i = 0; i < path.length - 1; i++) {
            const nextInPath = path[i];
            if(currentNode._children) {
              currentNode.children = currentNode._children;
              currentNode._children = null;
            }
            currentNode = nextInPath;
          }
          
          update(root);
          
          // Ahora hacer "click" en el target para abrirlo
          setTimeout(() => {
            performTargetAction();
          }, 400);
        }
        
        function performTargetAction() {
          // Centrar primero en el target
          centerOnNode(target, 600, 0.8);
          showInfo(target);
          
          // Resaltar el target
          const targetElement = g.selectAll('.node').filter(d => d === target);
          targetElement.select('rect')
            .transition().duration(400)
            .attr('stroke', '#ff6b6b')
            .attr('stroke-width', 3);
          
          // Si el target tiene hijos, hacer "toggle" para abrirlo
          setTimeout(() => {
            if(target._children) {
              // Simular clic: abrir los hijos
              target.children = target._children;
              target._children = null;
              update(root);
              
              // Recentrar para mostrar la nueva estructura
              setTimeout(() => {
                centerOnNode(target, 800, 0.7);
              }, 600);
            }
          }, 800);
          
          // Despu√©s de mostrar el contenido, remover el resaltado
          setTimeout(() => {
            targetElement.select('rect')
              .transition().duration(400)
              .attr('stroke', '#232b3e')
              .attr('stroke-width', 1);
          }, 3000);
        }
        
        makeTargetVisible();
      }
    }
    
    // Nueva funci√≥n para cerrar una secci√≥n antes de pasar a la siguiente
    function closeCurrentSection(targetName) {
      const target = mainRoot.descendants().find(n => 
        (n.data.name || "").includes(targetName)
      );
      
      if(target && target.children) {
        // Cerrar los hijos (simular clic de colapso)
        target._children = target.children;
        target.children = null;
        update(root);
        
        // Recentrar en el padre
        setTimeout(() => {
          if(target.parent) {
            centerOnNode(target.parent, 600, 0.8);
          } else {
            centerRoot();
          }
        }, 300);
      }
    }

    function showTourMessage(message, current, total, notes = "") {
      // Remover mensaje anterior
      const existing = document.getElementById('tourMessage');
      if(existing) existing.remove();
      
      // Crear mensaje m√°s peque√±o y menos intrusivo
      const messageDiv = document.createElement('div');
      messageDiv.id = 'tourMessage';
      messageDiv.style.cssText = `
        position: fixed;
        top: 10px;
        right: 20px;
        background: rgba(44, 90, 160, 0.92);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 350px;
        border: 2px solid #4da3ff;
      `;
      
      const notesHTML = notes ? `<div style="font-size: 12px; opacity: 0.9; margin: 8px 0; font-style: italic;">${notes}</div>` : '';
      
      messageDiv.innerHTML = `
        <div style="font-size: 15px; margin-bottom: 8px;">${message}</div>
        ${notesHTML}
        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 12px;">Paso ${current} de ${total}</div>
        <div style="display: flex; gap: 8px; justify-content: center;">
          <button onclick="previousTourStep()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;" ${current <= 1 ? 'disabled' : ''}>‚óÄ</button>
          <button onclick="nextTourStep()" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;" ${current >= total ? 'disabled' : ''}>Siguiente ‚ñ∂</button>
          <button onclick="stopAutoTour()" style="background: rgba(255,107,107,0.8); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï</button>
        </div>
      `;
      
      document.body.appendChild(messageDiv);
    }

    function previousTourStep() {
      if(currentTourStep > 0) {
        currentTourStep--;
        executeTourStep(currentTourStep);
      }
    }

    function nextTourStep() {
      if(currentTourStep < tourSteps.length - 1) {
        currentTourStep++;
        executeTourStep(currentTourStep);
      }
    }

    // Conectar bot√≥n de tour
    document.getElementById('btnAutoTour').onclick = startAutoTour;

    // Controles de teclado para presentaci√≥n
    document.addEventListener('keydown', (event) => {
      if (document.getElementById('presentationMode').style.display === 'flex') {
        if (event.key === 'ArrowRight' || event.key === ' ') {
          nextSlide();
        } else if (event.key === 'ArrowLeft') {
          previousSlide();
        } else if (event.key === 'Escape') {
          closePresentationMode();
        }
      }
    });

    // ==============================
    // 10) Inicializaci√≥n final
    // ==============================
    // Asegurar que todas las funciones est√©n definidas antes de la inicializaci√≥n
    update(root);
    centerRoot();
  </script>
</body>
</html>